<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Keuangan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Outfit", "sans-serif"],
            },
            colors: {
              primary: "#4f46e5",
              secondary: "#10b981",
              danger: "#ef4444",
            },
          },
        },
      };
    </script>

    <style>
      body {
        font-family: "Outfit", sans-serif;
        background-color: #ffffff;
        color: #1f2937;
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      ::-webkit-scrollbar-thumb {
        background: #c7c7c7;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
      }

      .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(229, 231, 235, 0.5);
        box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05);
      }

      .gradient-card-1 {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
      }

      .gradient-card-2 {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
      }

      .gradient-card-3 {
        background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
        color: white;
      }

      .gradient-card-4 {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
      }

      .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
      }

      /* Mobile Adjustments */
      @media (max-width: 640px) {
        .chart-container {
          height: 250px;
        }
      }

      .animate-fade-in {
        animation: fadeIn 0.5s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>

  <body
    class="antialiased selection:bg-indigo-100 selection:text-indigo-700 pb-20 md:pb-0"
  >
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Header Section -->
      <header class="mb-10 animate-fade-in">
        <div
          class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6"
        >
          <div>
            <h1
              class="text-3xl md:text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600"
            >
              Dashboard Keuangan
            </h1>
            <p class="text-gray-500 mt-1 font-medium flex items-center gap-2">
              <i class="fas fa-plane-departure text-indigo-500"></i>
              <span>Target 2026: Umroh Aamiin</span>
            </p>
          </div>

          <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
            <button
              onclick="showAddModal()"
              class="group relative inline-flex items-center justify-center px-6 py-3 text-base font-medium text-white transition-all duration-200 bg-indigo-600 rounded-xl hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 shadow-lg shadow-indigo-500/30 hover:shadow-indigo-500/50 w-full sm:w-auto"
            >
              <i
                class="fas fa-plus mr-2 transition-transform group-hover:rotate-90"
              ></i>
              Tambah Transaksi
            </button>
            <div class="flex gap-2 w-full sm:w-auto">
              <button
                onclick="exportToExcel()"
                class="flex-1 sm:flex-none px-4 py-3 bg-white text-gray-700 border border-gray-200 rounded-xl hover:bg-gray-50 hover:text-green-600 transition-colors duration-200 font-medium shadow-sm"
              >
                <i class="fas fa-file-excel"></i>
              </button>
              <button
                onclick="getRingkasanBulanan()"
                class="flex-1 sm:flex-none px-4 py-3 bg-white text-gray-700 border border-gray-200 rounded-xl hover:bg-gray-50 hover:text-indigo-600 transition-colors duration-200 font-medium shadow-sm"
              >
                <i class="fas fa-calendar-alt"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Modern Filters -->
        <div
          class="mt-8 p-1 bg-gray-100/50 rounded-2xl border border-gray-200 inline-block w-full"
        >
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 p-2">
            <div class="relative group">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <span
                  class="text-gray-400 text-xs font-semibold uppercase tracking-wider"
                  >Dari</span
                >
              </div>
              <input
                type="date"
                id="start-date"
                class="block w-full pl-12 pr-3 py-2.5 text-sm font-medium text-gray-900 bg-white border-0 rounded-xl focus:ring-2 focus:ring-indigo-500 shadow-sm transition-all"
              />
            </div>
            <div class="relative group">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <span
                  class="text-gray-400 text-xs font-semibold uppercase tracking-wider"
                  >Sampai</span
                >
              </div>
              <input
                type="date"
                id="end-date"
                class="block w-full pl-16 pr-3 py-2.5 text-sm font-medium text-gray-900 bg-white border-0 rounded-xl focus:ring-2 focus:ring-indigo-500 shadow-sm transition-all"
              />
            </div>
            <div class="relative">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <i class="fas fa-filter text-gray-400"></i>
              </div>
              <select
                id="filter-tipe"
                class="block w-full pl-10 pr-10 py-2.5 text-sm font-medium text-gray-900 bg-white border-0 rounded-xl focus:ring-2 focus:ring-indigo-500 shadow-sm appearance-none cursor-pointer"
              >
                <option value="">Semua Tipe</option>
                <option value="pemasukan">Pemasukan</option>
                <option value="pengeluaran">Pengeluaran</option>
              </select>
              <div
                class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"
              >
                <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- Stats Cards Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
        <!-- Pemasukan -->
        <div
          class="gradient-card-1 rounded-3xl p-6 relative overflow-hidden shadow-xl shadow-green-500/20 transform transition hover:scale-[1.02] cursor-default"
        >
          <div
            class="absolute right-0 top-0 h-32 w-32 bg-white opacity-10 rounded-full blur-2xl transform translate-x-10 -translate-y-10"
          ></div>
          <div class="relative z-10">
            <div class="flex justify-between items-start mb-4">
              <div class="p-3 bg-white/20 rounded-2xl backdrop-blur-sm">
                <i class="fas fa-arrow-down text-xl"></i>
              </div>
              <span
                class="px-3 py-1 bg-white/20 rounded-full text-xs font-medium backdrop-blur-sm"
                >Total</span
              >
            </div>
            <p class="text-sm font-medium text-green-50 opacity-90">
              Pemasukan
            </p>
            <h3
              class="text-2xl font-bold mt-1 tracking-tight"
              id="total-pemasukan"
            >
              Rp 0
            </h3>
          </div>
        </div>

        <!-- Pengeluaran -->
        <div
          class="gradient-card-2 rounded-3xl p-6 relative overflow-hidden shadow-xl shadow-red-500/20 transform transition hover:scale-[1.02] cursor-default"
        >
          <div
            class="absolute right-0 top-0 h-32 w-32 bg-white opacity-10 rounded-full blur-2xl transform translate-x-10 -translate-y-10"
          ></div>
          <div class="relative z-10">
            <div class="flex justify-between items-start mb-4">
              <div class="p-3 bg-white/20 rounded-2xl backdrop-blur-sm">
                <i class="fas fa-arrow-up text-xl"></i>
              </div>
            </div>
            <p class="text-sm font-medium text-red-50 opacity-90">
              Pengeluaran
            </p>
            <h3
              class="text-2xl font-bold mt-1 tracking-tight"
              id="total-pengeluaran"
            >
              Rp 0
            </h3>
          </div>
        </div>

        <!-- Saldo -->
        <div
          class="gradient-card-3 rounded-3xl p-6 relative overflow-hidden shadow-xl shadow-indigo-500/20 transform transition hover:scale-[1.02] cursor-default"
        >
          <div
            class="absolute right-0 top-0 h-32 w-32 bg-white opacity-10 rounded-full blur-2xl transform translate-x-10 -translate-y-10"
          ></div>
          <div class="relative z-10">
            <div class="flex justify-between items-start mb-4">
              <div class="p-3 bg-white/20 rounded-2xl backdrop-blur-sm">
                <i class="fas fa-wallet text-xl"></i>
              </div>
              <span
                class="px-3 py-1 bg-white/20 rounded-full text-xs font-medium backdrop-blur-sm"
                >Net</span
              >
            </div>
            <p class="text-sm font-medium text-indigo-50 opacity-90">
              Sisa Saldo
            </p>
            <h3 class="text-2xl font-bold mt-1 tracking-tight" id="saldo">
              Rp 0
            </h3>
          </div>
        </div>

        <!-- Transaksi -->
        <div
          class="gradient-card-4 rounded-3xl p-6 relative overflow-hidden shadow-xl shadow-purple-500/20 transform transition hover:scale-[1.02] cursor-default"
        >
          <div
            class="absolute right-0 top-0 h-32 w-32 bg-white opacity-10 rounded-full blur-2xl transform translate-x-10 -translate-y-10"
          ></div>
          <div class="relative z-10">
            <div class="flex justify-between items-start mb-4">
              <div class="p-3 bg-white/20 rounded-2xl backdrop-blur-sm">
                <i class="fas fa-receipt text-xl"></i>
              </div>
            </div>
            <p class="text-sm font-medium text-purple-50 opacity-90">
              Total Transaksi
            </p>
            <h3
              class="text-2xl font-bold mt-1 tracking-tight"
              id="jumlah-transaksi"
            >
              0
            </h3>
          </div>
        </div>
      </div>

      <!-- Charts Layout -->
      <div class="grid grid-cols-12 gap-6 mb-10">
        <!-- Row 1 -->
        <!-- Chart Left (Trend) -->
        <div class="col-span-12 lg:col-span-8">
          <div
            class="bg-white rounded-3xl p-6 shadow-xl shadow-gray-200/50 border border-gray-100 h-full"
          >
            <div class="flex justify-between items-center mb-6">
              <div>
                <h3 class="text-lg font-bold text-gray-800">Trend Keuangan</h3>
                <p class="text-sm text-gray-500">
                  Analisis harian pemasukan & pengeluaran
                </p>
              </div>
              <div class="hidden sm:flex gap-2">
                <span
                  class="flex items-center gap-2 text-xs font-medium text-gray-500"
                >
                  <span class="w-3 h-3 rounded-full bg-green-500"></span> Masuk
                </span>
                <span
                  class="flex items-center gap-2 text-xs font-medium text-gray-500"
                >
                  <span class="w-3 h-3 rounded-full bg-red-500"></span> Keluar
                </span>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="dailyLineChart"></canvas>
            </div>
            <div
              id="dailyLineLegend"
              class="flex flex-wrap gap-4 mt-4 justify-center sm:hidden text-xs"
            ></div>
          </div>
        </div>

        <!-- Chart Name (New) -->
        <div class="col-span-12 lg:col-span-4">
          <div
            class="bg-white rounded-3xl p-6 shadow-xl shadow-gray-200/50 border border-gray-100 h-full"
          >
            <h3 class="text-lg font-bold text-gray-800 mb-4">
              Transaksi per Nama
            </h3>
            <div class="h-[200px] relative">
              <canvas id="namaPieChart"></canvas>
            </div>
            <div
              id="namaPieLegend"
              class="flex flex-wrap gap-2 mt-4 justify-center text-xs"
            ></div>
          </div>
        </div>

        <!-- Row 2 -->
        <!-- Chart Category (Bar) -->
        <div class="col-span-12 lg:col-span-8">
          <div
            class="bg-white rounded-3xl p-6 shadow-xl shadow-gray-200/50 border border-gray-100"
          >
            <h3 class="text-lg font-bold text-gray-800 mb-4">Top Kategori</h3>
            <div class="h-[250px] relative">
              <canvas id="kategoriBarChart"></canvas>
            </div>
            <div id="kategoriBarLegend" class="hidden"></div>
          </div>
        </div>

        <!-- Chart Type (Pie) -->
        <div class="col-span-12 lg:col-span-4">
          <div
            class="bg-white rounded-3xl p-6 shadow-xl shadow-gray-200/50 border border-gray-100 h-full"
          >
            <h3 class="text-lg font-bold text-gray-800 mb-4">
              Porsi Transaksi
            </h3>
            <div class="h-[200px] relative">
              <canvas id="tipePieChart"></canvas>
            </div>
            <div
              id="tipePieLegend"
              class="flex flex-wrap gap-2 mt-4 justify-center text-xs"
            ></div>
          </div>
        </div>
      </div>

      <!-- Recent Transactions -->
      <div
        class="bg-white rounded-3xl shadow-xl shadow-gray-200/50 border border-gray-100 overflow-hidden"
      >
        <div
          class="p-6 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4"
        >
          <h3 class="text-xl font-bold text-gray-800">Riwayat Transaksi</h3>
          <!-- Search could go here -->
        </div>

        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="bg-gray-50/50 border-b border-gray-100">
                <th
                  class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"
                >
                  Tanggal
                </th>
                <th
                  class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"
                >
                  Nama
                </th>
                <th
                  class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"
                >
                  Detail
                </th>
                <th
                  class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"
                >
                  Kategori
                </th>
                <th
                  class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"
                >
                  Nominal
                </th>
                <th
                  class="px-6 py-4 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider"
                >
                  Aksi
                </th>
              </tr>
            </thead>
            <tbody id="data-table" class="divide-y divide-gray-100">
              <!-- JS fills this -->
            </tbody>
          </table>
        </div>

        <!-- States -->
        <div id="loading" class="hidden p-12 text-center">
          <div
            class="inline-flex items-center justify-center p-4 bg-indigo-50 rounded-full mb-4"
          >
            <svg
              class="animate-spin h-8 w-8 text-indigo-600"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
          </div>
          <p class="text-gray-500 font-medium">Sedang memuat data...</p>
        </div>

        <div id="no-data" class="hidden p-12 text-center">
          <div
            class="inline-flex items-center justify-center p-4 bg-gray-50 rounded-full mb-4"
          >
            <i class="fas fa-inbox text-gray-400 text-3xl"></i>
          </div>
          <p class="text-gray-500 font-medium">Belum ada transaksi</p>
        </div>
      </div>
    </div>

    <!-- Modal Form -->
    <div
      id="modal"
      class="fixed inset-0 z-50 overflow-y-auto hidden"
      aria-labelledby="modal-title"
      role="dialog"
      aria-modal="true"
    >
      <!-- Backdrop -->
      <div
        class="fixed inset-0 bg-gray-900/60 transition-opacity backdrop-blur-sm"
      ></div>

      <div
        class="flex min-h-screen items-center justify-center p-4 text-center sm:p-0"
      >
        <div
          class="relative transform overflow-hidden rounded-3xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-gray-100"
        >
          <div class="bg-white px-6 py-6 sm:p-8">
            <div class="flex items-center justify-between mb-6">
              <h3
                class="text-2xl font-bold leading-6 text-gray-900"
                id="modal-title"
              >
                Tambah Transaksi
              </h3>
              <button
                id="cancel-btn-x"
                type="button"
                class="text-gray-400 hover:text-gray-500"
              >
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>

            <form id="transaksi-form" class="space-y-5">
              <input type="hidden" id="edit-id" />

              <!-- Tipe Selection Buttons -->
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <input
                    type="radio"
                    name="tipe_radio"
                    value="pemasukan"
                    id="radio_pemasukan"
                    class="peer hidden"
                    required
                  />
                  <label
                    for="radio_pemasukan"
                    class="flex flex-col items-center justify-center p-4 rounded-xl border-2 border-gray-200 cursor-pointer hover:bg-green-50 peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 transition-all"
                  >
                    <i class="fas fa-arrow-down mb-2 text-xl"></i>
                    <span class="font-medium">Pemasukan</span>
                  </label>
                </div>
                <div>
                  <input
                    type="radio"
                    name="tipe_radio"
                    value="pengeluaran"
                    id="radio_pengeluaran"
                    class="peer hidden"
                    required
                  />
                  <label
                    for="radio_pengeluaran"
                    class="flex flex-col items-center justify-center p-4 rounded-xl border-2 border-gray-200 cursor-pointer hover:bg-red-50 peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 transition-all"
                  >
                    <i class="fas fa-arrow-up mb-2 text-xl"></i>
                    <span class="font-medium">Pengeluaran</span>
                  </label>
                </div>
              </div>
              <!-- Hidden select for compatibility with existing JS -->
              <select id="form-tipe" class="hidden">
                <option value="pemasukan">Pemasukan</option>
                <option value="pengeluaran">Pengeluaran</option>
              </select>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Tanggal & Waktu</label
                >
                <input
                  type="date"
                  id="form-tanggal"
                  required
                  class="w-full rounded-xl border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-3 px-4 bg-gray-50"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Penanggung Jawab</label
                >
                <select
                  id="form-nama"
                  required
                  class="w-full rounded-xl border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-3 px-4 bg-gray-50"
                >
                  <option value="">Pilih Nama</option>
                  <option value="Yayan">Yayan</option>
                  <option value="Dian">Dian</option>
                  <option value="Kira">Kira</option>
                </select>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Kategori</label
                  >
                  <select
                    id="form-kategori"
                    required
                    class="w-full rounded-xl border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-3 px-4 bg-gray-50"
                  >
                    <option value="">Pilih Kategori</option>
                    <option value="Gaji">Gaji</option>
                    <option value="Bonus">Bonus</option>
                    <option value="Freelance">Freelance</option>
                    <option value="Investasi">Investasi</option>
                    <option value="Recash">Recash</option>
                    <option value="Hutang">Hutang</option>
                    <option value="Makan">Makan</option>
                    <option value="Kebutuhan Makan">Kebutuhan Makan</option>
                    <option value="BBM">BBM</option>
                    <option value="Tabungan">Tabungan</option>
                    <option value="Obat">Obat</option>
                    <option value="E-Toll">E-Toll</option>
                    <option value="Listrik">Listrik</option>
                    <option value="Wifi dan Internet">Wifi dan Internet</option>
                    <option value="Lain-lain">Lain-lain</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Jumlah (Rp)</label
                  >
                  <div class="relative">
                    <div
                      class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                    >
                      <span class="text-gray-500 sm:text-sm">Rp</span>
                    </div>
                    <input
                      type="number"
                      id="form-amount"
                      required
                      min="0"
                      step="0.01"
                      class="w-full rounded-xl border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-3 pl-10 px-4 bg-gray-50 font-semibold text-gray-900"
                      placeholder="0"
                    />
                  </div>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Keperluan / Catatan</label
                >
                <textarea
                  id="form-keperluan"
                  rows="2"
                  required
                  class="w-full rounded-xl border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-3 px-4 bg-gray-50"
                  placeholder="Contoh: Makan siang di warteg"
                ></textarea>
              </div>

              <div class="mt-8 flex gap-3">
                <button
                  type="button"
                  id="cancel-btn"
                  class="flex-1 rounded-xl bg-white border border-gray-300 px-5 py-3 text-sm font-semibold text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all"
                >
                  Batal
                </button>
                <button
                  type="submit"
                  class="flex-1 rounded-xl bg-indigo-600 px-5 py-3 text-sm font-semibold text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all shadow-indigo-500/30"
                >
                  Simpan Data
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Chart instances
      let tipePieChart = null;
      let namaPieChart = null;
      let kategoriBarChart = null;
      let dailyLineChart = null;

      $(document).ready(function () {
        // Set default date range to current month
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today);

        $("#start-date").val(formatDate(firstDay));
        $("#end-date").val(formatDate(lastDay));
        $("#form-tanggal").val(formatDate(today));

        // Load initial data
        loadData();

        // Date change events
        $("#start-date, #end-date, #filter-tipe").change(function () {
          loadData();
        });

        // Modal events
        $("#cancel-btn, #cancel-btn-x").click(function () {
          $("#modal").addClass("hidden");
        });

        // Radio button logic to update hidden select for compatibility
        $('input[name="tipe_radio"]').change(function () {
          $("#form-tipe").val($(this).val());
        });

        // Form submission
        $("#transaksi-form").submit(function (e) {
          e.preventDefault();
          saveTransaksi();
        });

        // Close modal when clicking outside
        $("#modal").click(function (e) {
          if (e.target === this || $(e.target).hasClass("backdrop-blur-sm")) {
            $(this).addClass("hidden");
          }
        });
      });

      function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
          minimumFractionDigits: 0,
        }).format(amount);
      }

      function loadData() {
        const startDate = $("#start-date").val();
        const endDate = $("#end-date").val();
        const filterTipe = $("#filter-tipe").val();

        // Show loading
        $("#loading").removeClass("hidden");
        $("#data-table").addClass("hidden");
        $("#no-data").addClass("hidden");

        // Build URL with query parameters
        let url = `/transactions/filter?start=${startDate}&end=${endDate}`;
        if (filterTipe) {
          url += `&tipe=${filterTipe}`;
        }

        $.ajax({
          url: url,
          method: "GET",
          dataType: "json",
          success: function (response) {
            const data = response;
            updateSummary(data);
            updateCharts(data, startDate, endDate);
            if (data.length > 0) {
              renderTable(data);
              $("#data-table").removeClass("hidden");
            } else {
              $("#no-data").removeClass("hidden");
            }
            $("#loading").addClass("hidden");
          },
          error: function (err) {
            $("#loading").addClass("hidden");
            $("#no-data").removeClass("hidden");
            console.error("Error fetching data:", err);
          },
        });
      }

      function updateSummary(data) {
        let totalPemasukan = 0;
        let totalPengeluaran = 0;

        data.forEach((item) => {
          if (item.tipe === "pemasukan") {
            totalPemasukan += item.amount;
          } else if (item.tipe === "pengeluaran") {
            totalPengeluaran += item.amount;
          }
        });

        const saldo = totalPemasukan - totalPengeluaran;
        const count = data.length;

        $("#total-pemasukan").text(formatCurrency(totalPemasukan));
        $("#total-pengeluaran").text(formatCurrency(totalPengeluaran));
        $("#saldo").text(formatCurrency(saldo));
        $("#jumlah-transaksi").text(count + " Data");
      }

      function updateCharts(data, startDate, endDate) {
        // 1. Pie Chart - Analisis Pemasukan vs Pengeluaran
        updateTipePieChart(data);

        // 2. Bar Chart - Analisis Berdasarkan Kategori
        updateKategoriBarChart(data);

        // 3. Line Chart - Trend Keuangan Harian
        updateDailyLineChart(data, startDate, endDate);

        // 4. Pie Chart - Analisis Berdasarkan Nama
        updateNamaPieChart(data);
      }

      function updateNamaPieChart(data) {
        const ctx = document.getElementById("namaPieChart").getContext("2d");

        // Group data by Nama
        const namaGroups = {};
        data.forEach((item) => {
            if (!namaGroups[item.nama]) {
                namaGroups[item.nama] = 0;
            }
            // Summing amount for visualization regardless of type
            namaGroups[item.nama] += item.amount;
        });

        // Filter out zero values if any
        const labels = Object.keys(namaGroups);
        const values = Object.values(namaGroups);
        const colors = ["#3b82f6", "#8b5cf6", "#ec4899", "#f59e0b", "#10b981"];

        if (namaPieChart) {
            namaPieChart.destroy();
        }

        namaPieChart = new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    borderWidth: 0,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: "60%",
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const label = context.label || "";
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // Reuse the TipeLegend function as it is generic enough (labels, colors, values)
        updateTipeLegend("namaPieLegend", labels, colors, values);
      }

      function updateTipePieChart(data) {
        const ctx = document.getElementById("tipePieChart").getContext("2d");

        // Group data by tipe
        const tipeGroups = {
          pemasukan: 0,
          pengeluaran: 0,
        };

        data.forEach((item) => {
          if (item.tipe in tipeGroups) {
            tipeGroups[item.tipe] += item.amount;
          }
        });

        const labels = ["Pemasukan", "Pengeluaran"];
        const values = [tipeGroups.pemasukan, tipeGroups.pengeluaran];
        const colors = ["#10b981", "#ef4444"];

        // Destroy existing chart if it exists
        if (tipePieChart) {
          tipePieChart.destroy();
        }

        tipePieChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: values,
                backgroundColor: colors,
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "70%",
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const label = context.label || "";
                    const value = context.raw || 0;
                    const total = context.dataset.data.reduce(
                      (a, b) => a + b,
                      0
                    );
                    const percentage =
                      total > 0 ? Math.round((value / total) * 100) : 0;
                    return `${label}: ${formatCurrency(
                      value
                    )} (${percentage}%)`;
                  },
                },
              },
            },
          },
        });

        // Update custom legend
        updateTipeLegend("tipePieLegend", labels, colors, values);
      }

      function updateKategoriBarChart(data) {
        const ctx = document
          .getElementById("kategoriBarChart")
          .getContext("2d");

        // Group data by kategori
        const kategoriGroups = {};
        data.forEach((item) => {
          if (!kategoriGroups[item.kategori]) {
            kategoriGroups[item.kategori] = 0;
          }
          if (item.tipe === "pengeluaran") {
            kategoriGroups[item.kategori] += item.amount;
          }
        });

        // Sort by value (descending)
        const sortedEntries = Object.entries(kategoriGroups)
          .filter(([_, value]) => value > 0)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5); // Take top 5

        const labels = sortedEntries.map((entry) => entry[0]);
        const values = sortedEntries.map((entry) => entry[1]);

        // Generate colors
        const colors = generateColors(labels.length);

        // Destroy existing chart if it exists
        if (kategoriBarChart) {
          kategoriBarChart.destroy();
        }

        kategoriBarChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Total Pengeluaran",
                data: values,
                backgroundColor: colors,
                borderRadius: 8,
                barThickness: 30,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                grid: { display: false },
                ticks: { display: false },
              },
              x: {
                grid: { display: false },
                ticks: { font: { size: 10 } },
              },
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: "rgba(0,0,0,0.8)",
                padding: 12,
                callbacks: {
                  label: function (context) {
                    return `${context.dataset.label}: ${formatCurrency(
                      context.raw
                    )}`;
                  },
                },
              },
            },
            plugins: [
              {
                afterDatasetsDraw(chart, args, pluginOptions) {
                  const { ctx } = chart;
                  chart.data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    meta.data.forEach((bar, index) => {
                      const value = dataset.data[index];
                      const displayValue = (value / 1000).toFixed(0) + "k";
                      ctx.save();
                      ctx.fillStyle = "#6b7280";
                      ctx.font = "10px Outfit";
                      ctx.textAlign = "center";
                      ctx.fillText(displayValue, bar.x, bar.y - 6);
                      ctx.restore();
                    });
                  });
                },
              },
            ],
          },
        });
      }

      function updateDailyLineChart(data, startDate, endDate) {
        const ctx = document.getElementById("dailyLineChart").getContext("2d");

        // Group data by date and tipe
        const dateGroups = {};
        data.forEach((item) => {
          const date = new Date(item.tanggal).toISOString().split("T")[0];
          if (!dateGroups[date]) {
            dateGroups[date] = { pemasukan: 0, pengeluaran: 0 };
          }
          dateGroups[date][item.tipe] += item.amount;
        });

        // Create array of all dates in range
        const start = new Date(startDate);
        const end = new Date(endDate);
        const allDates = [];
        const currentDate = new Date(start);

        // Limit to max 31 days to prevent chart crowding if range is huge
        while (currentDate <= end) {
          allDates.push(currentDate.toISOString().split("T")[0]);
          currentDate.setDate(currentDate.getDate() + 1);
        }

        // Prepare data for chart
        const labels = allDates.map((date) => {
          const d = new Date(date);
          return `${d.getDate()}`; // Just day
        });

        const pemasukanData = allDates.map(
          (date) => dateGroups[date]?.pemasukan || 0
        );
        const pengeluaranData = allDates.map(
          (date) => dateGroups[date]?.pengeluaran || 0
        );

        // Destroy existing chart if it exists
        if (dailyLineChart) {
          dailyLineChart.destroy();
        }

        // Create gradient
        let gradientPemasukan = ctx.createLinearGradient(0, 0, 0, 400);
        gradientPemasukan.addColorStop(0, "rgba(16, 185, 129, 0.2)");
        gradientPemasukan.addColorStop(1, "rgba(16, 185, 129, 0)");

        let gradientPengeluaran = ctx.createLinearGradient(0, 0, 0, 400);
        gradientPengeluaran.addColorStop(0, "rgba(239, 68, 68, 0.2)");
        gradientPengeluaran.addColorStop(1, "rgba(239, 68, 68, 0)");

        dailyLineChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Pemasukan",
                data: pemasukanData,
                backgroundColor: gradientPemasukan,
                borderColor: "#10b981",
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 6,
              },
              {
                label: "Pengeluaran",
                data: pengeluaranData,
                backgroundColor: gradientPengeluaran,
                borderColor: "#ef4444",
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: "index",
              intersect: false,
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: "#f3f4f6" },
                ticks: {
                  display: false,
                },
                border: { display: false },
              },
              x: {
                grid: { display: false },
                border: { display: false },
                ticks: { font: { size: 10 } },
              },
            },
            plugins: {
              tooltip: {
                backgroundColor: "rgba(255, 255, 255, 0.9)",
                titleColor: "#1f2937",
                bodyColor: "#1f2937",
                borderColor: "#e5e7eb",
                borderWidth: 1,
                padding: 10,
                titleFont: { family: "Outfit", weight: "bold" },
                bodyFont: { family: "Outfit" },
                callbacks: {
                  label: function (context) {
                    return ` ${context.dataset.label}: ${formatCurrency(
                      context.raw
                    )}`;
                  },
                },
              },
              legend: { display: false },
            },
          },
        });
      }

      function updateTipeLegend(legendId, labels, colors, values) {
        const legendContainer = document.getElementById(legendId);
        let legendHtml = "";

        labels.forEach((label, index) => {
          const total = values.reduce((a, b) => a + b, 0);
          const percentage =
            total > 0 ? Math.round((values[index] / total) * 100) : 0;

          legendHtml += `
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full" style="background-color: ${colors[index]}"></div>
                        <span class="text-gray-600">${label} (${percentage}%)</span>
                    </div>
                `;
        });

        legendContainer.innerHTML = legendHtml;
      }

      function generateColors(count) {
        const colors = [
          "#4f46e5",
          "#8b5cf6",
          "#ec4899",
          "#f43f5e",
          "#f59e0b",
          "#10b981",
          "#06b6d4",
          "#3b82f6",
          "#6366f1",
          "#a855f7",
        ];
        return colors.slice(0, count);
      }

      function renderTable(data) {
        const tableBody = $("#data-table");
        tableBody.empty();

        data.forEach((item) => {
          const date = new Date(item.tanggal);
          // Format: 25 Jan 2026
          const formattedDate = date.toLocaleDateString("id-ID", {
            day: "numeric",
            month: "short",
            year: "numeric",
          });

          const isPemasukan = item.tipe === "pemasukan";
          const amountClass = isPemasukan ? "text-green-600" : "text-red-600";
          const sign = isPemasukan ? "+" : "-";
          const icon = isPemasukan
            ? "fa-arrow-down text-green-500 bg-green-50"
            : "fa-arrow-up text-red-500 bg-red-50";

          const row = `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${formattedDate}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-8 w-8 rounded-full ${
                                  isPemasukan ? "bg-green-100" : "bg-red-100"
                                } flex items-center justify-center mr-3">
                                   <span class="text-xs font-bold ${
                                     isPemasukan
                                       ? "text-green-700"
                                       : "text-red-700"
                                   }">${item.nama.substring(0, 1)}</span>
                                </div>
                                <div class="text-sm font-medium text-gray-900">${
                                  item.nama
                                }</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">
                             ${item.keperluan}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-600">
                                ${item.kategori}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${amountClass}">
                            ${sign} ${formatCurrency(item.amount)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="editTransaksi(${
                              item.ID
                            })" class="text-indigo-600 hover:text-indigo-900 mx-2 p-1.5 hover:bg-indigo-50 rounded-lg transition-colors">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteTransaksi(${
                              item.ID
                            })" class="text-red-400 hover:text-red-600 mx-2 p-1.5 hover:bg-red-50 rounded-lg transition-colors">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;

          tableBody.append(row);
        });
      }

      function showAddModal() {
        $("#modal-title").text("Tambah Transaksi");
        $("#edit-id").val("");
        $("#form-tipe").val("");
        $('input[name="tipe_radio"]').prop("checked", false);

        $("#form-tanggal").val(formatDate(new Date()));
        $("#form-nama").val("");
        $("#form-keperluan").val("");
        $("#form-kategori").val("");
        $("#form-amount").val("");
        $("#modal").removeClass("hidden");
      }

      function editTransaksi(id) {
        $.ajax({
          url: `/transactions/${id}`,
          method: "GET",
          dataType: "json",
          success: function (response) {
            const item = response;
            $("#modal-title").text("Edit Transaksi");
            $("#edit-id").val(item.ID);

            $("#form-tipe").val(item.tipe);
            $(`input[name="tipe_radio"][value="${item.tipe}"]`).prop(
              "checked",
              true
            );

            $("#form-tanggal").val(formatDate(new Date(item.tanggal)));
            $("#form-nama").val(item.nama);
            $("#form-keperluan").val(item.keperluan);
            $("#form-kategori").val(item.kategori);
            $("#form-amount").val(item.amount);
            $("#modal").removeClass("hidden");
          },
          error: function (err) {
            alert("Gagal mengambil data transaksi");
            console.error(err);
          },
        });
      }

      function saveTransaksi() {
        // Get value from hidden input or radio
        const tipeVal =
          $('input[name="tipe_radio"]:checked').val() || $("#form-tipe").val();

        if (!tipeVal) {
          alert("Pilih tipe transaksi!");
          return;
        }

        const id = $("#edit-id").val();
        const method = id ? "PUT" : "POST";
        const url = id ? "/transactions/" + id : "/transactions";

        const data = {
          nama: $("#form-nama").val(),
          keperluan: $("#form-keperluan").val(),
          kategori: $("#form-kategori").val(),
          tipe: tipeVal,
          amount: parseFloat($("#form-amount").val()),
          tanggal: $("#form-tanggal").val(),
        };

        $.ajax({
          url: url,
          method: method,
          contentType: "application/json",
          data: JSON.stringify(data),
          success: function (response) {
            $("#modal").addClass("hidden");
            loadData();
            // alert('Data berhasil disimpan!'); // Removed alert for smoother UX
          },
          error: function (err) {
            alert("Gagal menyimpan data!");
            console.error(err);
          },
        });
      }

      function deleteTransaksi(id) {
        if (confirm("Apakah Anda yakin ingin menghapus data ini?")) {
          $.ajax({
            url: `/transactions/${id}`,
            method: "DELETE",
            success: function (response) {
              loadData();
            },
            error: function (err) {
              alert("Gagal menghapus data!");
              console.error(err);
            },
          });
        }
      }

      function getRingkasanBulanan() {
        const today = new Date();
        const bulan =
          today.getFullYear() +
          "-" +
          String(today.getMonth() + 1).padStart(2, "0");

        $.ajax({
          url: `/transactions/resume/monthly?bulan=${bulan}`,
          method: "GET",
          dataType: "json",
          success: function (response) {
            // Modern alert (simulated with standard alert for now, but formatted better)
            const msg =
              `RINGKASAN ${response.periode}\n\n` +
              `----------------------------\n` +
              `Masuk  : ${formatCurrency(response.total_pemasukan)}\n` +
              `Keluar : ${formatCurrency(response.total_pengeluaran)}\n` +
              `----------------------------\n` +
              `SALDO  : ${formatCurrency(response.saldo)}`;
            alert(msg);
          },
          error: function (err) {
            console.error(err);
          },
        });
      }

      function exportToExcel() {
        const data = [];

        // Get headers
        const headers = [
          "Tanggal",
          "Nama",
          "Keperluan",
          "Kategori",
          "Tipe",
          "Jumlah",
        ];
        data.push(headers);

        // Fetch current displayed data from table
        const rows = $("#data-table tr");
        rows.each(function () {
          const row = [];
          // We need to be careful because the table display is different now
          // So relying on scraping DOM might be brittle if we hide columns
          // Better to use the global data if accessible, but for now let's scrape carefully
          // Implementation note: The DOM scraping here is simplified and might need adjustment
          // if strict CSV format is required.

          // Let's simply re-fetch or use logic that doesn't rely on DOM classes too much
          const cols = $(this).find("td");
          if (cols.length > 0) {
            row.push($(cols[0]).text().trim()); // Tanggal
            row.push($(cols[1]).find(".text-gray-900").text().trim()); // Nama
            row.push($(cols[2]).text().trim()); // Keperluan
            row.push($(cols[3]).text().trim()); // Kategori

            // Tipe deduction
            const isPemasukan = $(cols[4]).hasClass("text-green-600");
            row.push(isPemasukan ? "pemasukan" : "pengeluaran");

            // Amount cleanup
            row.push(
              $(cols[4])
                .text()
                .trim()
                .replace(/[^\d,-]/g, "")
            );
          }
          if (row.length > 0) data.push(row);
        });

        if (data.length > 1) {
          let csvContent = "data:text/csv;charset=utf-8,";
          data.forEach((row) => {
            csvContent += row.join(",") + "\n";
          });
          const encodedUri = encodeURI(csvContent);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", "laporan_keuangan.csv");
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }
    </script>
  </body>
</html>
