<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pemasukan & Pengeluaran</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
        }

        @media (max-width: 768px) {
            .desktop-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .desktop-header>div:first-child {
                margin-bottom: 1rem;
            }

            .card-grid {
                grid-template-columns: 1fr;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 300px !important;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .action-buttons button {
                width: 100%;
            }
        }

        @media (min-width: 768px) and (max-width: 1024px) {
            .chart-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .chart-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .shadow-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }

        .category-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .tipe-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .table-container {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        .table-container table {
            min-width: 100%;
        }

        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .pemasukan-text {
            color: #10b981;
        }

        .pengeluaran-text {
            color: #ef4444;
        }

        .saldo-text {
            color: #3b82f6;
        }
    </style>
</head>

<body class="font-poppins">

    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <header class="mb-8 desktop-header flex flex-col md:flex-row justify-between md:items-center gap-4 md:gap-8">

            <!-- Judul -->
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Dashboard Keuangan</h1>
                <p class="text-gray-600 text-sm md:text-base">
                    2026 Umroh Aamiin
                </p>
            </div>

            <!-- Filter & Button -->
            <div class="flex flex-col md:flex-row items-start md:items-center gap-4">

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 md:gap-6">
                    <div>
                        <input type="date" id="start-date"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <input type="date" id="end-date"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <select id="filter-tipe"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Semua Tipe</option>
                            <option value="pemasukan">Pemasukan</option>
                            <option value="pengeluaran">Pengeluaran</option>
                        </select>
                    </div>
                </div>
                <button onclick="showAddModal()"
                    class="px-4 py-2 md:px-6 md:py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 font-medium flex items-center shadow-md">
                    <i class="fas fa-plus mr-2"></i>
                    <span class="hidden sm:inline">Tambah Transaksi</span>
                </button>

            </div>
        </header>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 md:gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-card p-4 md:p-6 border-l-4 border-green-500">
                <div class="flex items-center">
                    <div class="p-2 rounded-full bg-green-100 text-green-600 mr-3">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div>
                        <h3 class="text-gray-500 text-sm font-medium">Total Pemasukan</h3>
                        <p class="text-xl md:text-2xl font-bold text-gray-800 pemasukan-text" id="total-pemasukan">Rp 0
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-card p-4 md:p-6 border-l-4 border-red-500">
                <div class="flex items-center">
                    <div class="p-2 rounded-full bg-red-100 text-red-600 mr-3">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div>
                        <h3 class="text-gray-500 text-sm font-medium">Total Pengeluaran</h3>
                        <p class="text-xl md:text-2xl font-bold text-gray-800 pengeluaran-text" id="total-pengeluaran">
                            Rp 0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-card p-4 md:p-6 border-l-4 border-blue-500">
                <div class="flex items-center">
                    <div class="p-2 rounded-full bg-blue-100 text-blue-600 mr-3">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <div>
                        <h3 class="text-gray-500 text-sm font-medium">Saldo</h3>
                        <p class="text-xl md:text-2xl font-bold text-gray-800 saldo-text" id="saldo">Rp 0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-card p-4 md:p-6 border-l-4 border-purple-500">
                <div class="flex items-center">
                    <div class="p-2 rounded-full bg-purple-100 text-purple-600 mr-3">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <div>
                        <h3 class="text-gray-500 text-sm font-medium">Jumlah Transaksi</h3>
                        <p class="text-xl md:text-2xl font-bold text-gray-800" id="jumlah-transaksi">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="chart-grid grid grid-cols-12 gap-4 md:gap-6 mb-8">

            <!-- Chart 1 - col 4 -->
            <div class="col-span-12 md:col-span-4 bg-white rounded-xl shadow-card p-4 md:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Pemasukan vs Pengeluaran</h3>
                    <i class="fas fa-chart-pie text-blue-500"></i>
                </div>
                <div class="chart-container">
                    <canvas id="tipePieChart"></canvas>
                </div>
                <div id="tipePieLegend" class="chart-legend"></div>
            </div>

            <!-- Chart 2 - col 8 -->
            <div class="col-span-12 md:col-span-8 bg-white rounded-xl shadow-card p-4 md:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Analisis Kategori</h3>
                    <i class="fas fa-chart-bar text-green-500"></i>
                </div>
                <div class="chart-container">
                    <canvas id="kategoriBarChart"></canvas>
                </div>
                <div id="kategoriBarLegend" class="chart-legend"></div>
            </div>

            <!-- Chart 3 - col 12 -->
            <div class="col-span-12 md:col-span-12 bg-white rounded-xl shadow-card p-4 md:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Trend Keuangan Harian</h3>
                    <i class="fas fa-chart-line text-purple-500"></i>
                </div>
                <div class="chart-container">
                    <canvas id="dailyLineChart"></canvas>
                </div>
                <div id="dailyLineLegend" class="chart-legend"></div>
            </div>

        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-xl shadow-card overflow-hidden">
            <div class="px-4 md:px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-lg md:text-xl font-semibold text-gray-800">Data Transaksi</h2>
                <div class="flex gap-2">
                    <button onclick="exportToExcel()"
                        class="px-3 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm">
                        <i class="fas fa-file-excel mr-1"></i> Excel
                    </button>
                    <button onclick="getRingkasanBulanan()"
                        class="px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm">
                        <i class="fas fa-chart-pie mr-1"></i> Ringkasan
                    </button>
                </div>
            </div>
            <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th
                                class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Tanggal
                            </th>
                            <th
                                class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Nama
                            </th>
                            <th
                                class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Keperluan
                            </th>
                            <th
                                class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Kategori
                            </th>
                            <th
                                class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Tipe
                            </th>
                            <th
                                class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Jumlah
                            </th>
                            <th
                                class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Aksi
                            </th>
                        </tr>
                    </thead>
                    <tbody id="data-table" class="bg-white divide-y divide-gray-200">
                        <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
            <div id="loading" class="hidden p-8 text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
                <p class="mt-2 text-gray-600">Memuat data...</p>
            </div>
            <div id="no-data" class="hidden p-8 text-center">
                <i class="fas fa-inbox text-gray-400 text-4xl mb-2"></i>
                <p class="text-gray-600">Tidak ada data yang ditemukan</p>
            </div>
        </div>
    </div>

    <!-- Modal untuk Tambah/Edit Data -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md modal-content">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-800" id="modal-title">Tambah Transaksi</h3>
            </div>
            <form id="transaksi-form" class="p-6">
                <input type="hidden" id="edit-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipe Transaksi</label>
                    <select id="form-tipe"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required>
                        <option value="">Pilih Tipe</option>
                        <option value="pemasukan">Pemasukan</option>
                        <option value="pengeluaran">Pengeluaran</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                    <input type="date" id="form-tanggal"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama</label>
                    <select id="form-nama"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required>
                        <option value="">Pilih Nama</option>
                        <option value="Yayan">Yayan</option>
                        <option value="Dian">Dian</option>
                        <option value="Kira">Kira</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Keperluan</label>
                    <input type="text" id="form-keperluan"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                    <select id="form-kategori"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required>
                        <option value="">Pilih Kategori</option>
                        <option value="Gaji">Gaji</option>
                        <option value="Bonus">Bonus</option>
                        <option value="Freelance">Freelance</option>
                        <option value="Investasi">Investasi</option>
                        <option value="Recash">Recash</option>
                        <option value="Hutang">Hutang</option>
                        <option value="Makan">Makan</option>
                        <option value="Kebutuhan Makan">Kebutuhan Makan</option>
                        <option value="BBM">BBM</option>
                        <option value="Tabungan">Tabungan</option>
                        <option value="Obat">Obat</option>
                        <option value="E-Toll">E-Toll</option>
                        <option value="Listrik">Listrik</option>
                        <option value="Wifi dan Internet">Wifi dan Internet</option>
                        <option value="Lain-lain">Lain-lain</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah (Rp)</label>
                    <input type="number" id="form-amount"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        min="0" step="0.01" required>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-btn"
                        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200 font-medium">
                        Batal
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Chart instances
        let tipePieChart = null;
        let kategoriBarChart = null;
        let dailyLineChart = null;

        $(document).ready(function () {
            // Set default date range to current month
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today);

            $('#start-date').val(formatDate(firstDay));
            $('#end-date').val(formatDate(lastDay));
            $('#form-tanggal').val(formatDate(today));

            // Load initial data
            loadData();

            // Date change events
            $('#start-date, #end-date, #filter-tipe').change(function () {
                loadData();
            });

            // Modal events
            $('#cancel-btn').click(function () {
                $('#modal').addClass('hidden');
            });

            // Form submission
            $('#transaksi-form').submit(function (e) {
                e.preventDefault();
                saveTransaksi();
            });

            // Close modal when clicking outside
            $('#modal').click(function (e) {
                if (e.target === this) {
                    $(this).addClass('hidden');
                }
            });
        });

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function loadData() {
            const startDate = $('#start-date').val();
            const endDate = $('#end-date').val();
            const filterTipe = $('#filter-tipe').val();

            // Show loading
            $('#loading').removeClass('hidden');
            $('#data-table').addClass('hidden');
            $('#no-data').addClass('hidden');

            // Build URL with query parameters
            let url = `/transactions/filter?start=${startDate}&end=${endDate}`;
            if (filterTipe) {
                url += `&tipe=${filterTipe}`;
            }

            $.ajax({
                url: url,
                method: 'GET',
                dataType: 'json',
                success: function (response) {
                    const data = response;
                    updateSummary(data);
                    updateCharts(data, startDate, endDate);
                    if (data.length > 0) {
                        renderTable(data);
                        $('#data-table').removeClass('hidden');
                    } else {
                        $('#no-data').removeClass('hidden');
                    }
                    $('#loading').addClass('hidden');
                },
                error: function (err) {
                    $('#loading').addClass('hidden');
                    $('#no-data').removeClass('hidden');
                    console.error('Error fetching data:', err);
                }
            });
        }

        function updateSummary(data) {
            let totalPemasukan = 0;
            let totalPengeluaran = 0;

            data.forEach(item => {
                if (item.tipe === 'pemasukan') {
                    totalPemasukan += item.amount;
                } else if (item.tipe === 'pengeluaran') {
                    totalPengeluaran += item.amount;
                }
            });

            const saldo = totalPemasukan - totalPengeluaran;
            const count = data.length;

            $('#total-pemasukan').text(formatCurrency(totalPemasukan));
            $('#total-pengeluaran').text(formatCurrency(totalPengeluaran));
            $('#saldo').text(formatCurrency(saldo));
            $('#jumlah-transaksi').text(count);
        }

        function updateCharts(data, startDate, endDate) {
            // 1. Pie Chart - Analisis Pemasukan vs Pengeluaran
            updateTipePieChart(data);

            // 2. Bar Chart - Analisis Berdasarkan Kategori
            updateKategoriBarChart(data);

            // 3. Line Chart - Trend Keuangan Harian
            updateDailyLineChart(data, startDate, endDate);
        }

        function updateTipePieChart(data) {
            const ctx = document.getElementById('tipePieChart').getContext('2d');

            // Group data by tipe
            const tipeGroups = {
                pemasukan: 0,
                pengeluaran: 0
            };

            data.forEach(item => {
                if (item.tipe in tipeGroups) {
                    tipeGroups[item.tipe] += item.amount;
                }
            });

            const labels = ['Pemasukan', 'Pengeluaran'];
            const values = [tipeGroups.pemasukan, tipeGroups.pengeluaran];
            const colors = ['rgba(16, 185, 129, 0.8)', 'rgba(239, 68, 68, 0.8)'];

            // Destroy existing chart if it exists
            if (tipePieChart) {
                tipePieChart.destroy();
            }

            tipePieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Update custom legend
            updateTipeLegend('tipePieLegend', labels, colors, values);
        }

        function updateKategoriBarChart(data) {
            const ctx = document.getElementById('kategoriBarChart').getContext('2d');

            // Group data by kategori
            const kategoriGroups = {};
            data.forEach(item => {
                if (!kategoriGroups[item.kategori]) {
                    kategoriGroups[item.kategori] = 0;
                }
                if (item.tipe === 'pengeluaran') {
                    kategoriGroups[item.kategori] += item.amount;
                }
            });

            // Sort by value (descending)
            const sortedEntries = Object.entries(kategoriGroups)
                .filter(([_, value]) => value > 0)
                .sort((a, b) => b[1] - a[1]);

            const labels = sortedEntries.map(entry => entry[0]);
            const values = sortedEntries.map(entry => entry[1]);

            // Generate colors
            const colors = generateColors(labels.length);

            // Destroy existing chart if it exists
            if (kategoriBarChart) {
                kategoriBarChart.destroy();
            }

            kategoriBarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Pengeluaran',
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 1,
                        borderColor: colors.map(color => color.replace('0.8', '1')),
                        borderRadius: 10,        // RADIUS BAR
                        // borderSkipped: true     // agar bulat semua sisi
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: { top: 20 }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { display: false },
                            ticks: { display: false }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                },
                plugins: [{
                    afterDatasetsDraw(chart, args, pluginOptions) {
                        const { ctx } = chart;

                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);

                            meta.data.forEach((bar, index) => {
                                const value = dataset.data[index];
                                const displayValue = (value / 1000).toFixed(1) + "K";

                                ctx.save();
                                ctx.fillStyle = "#000";
                                ctx.font = "15px poppins";
                                ctx.textAlign = "center";
                                ctx.fillText(displayValue, bar.x, bar.y - 6);
                                ctx.restore();
                            });
                        });
                    }
                }]
            });

            // Update custom legend
            updateLegend('kategoriBarLegend', labels, colors, values);
        }

        function updateDailyLineChart(data, startDate, endDate) {
            const ctx = document.getElementById('dailyLineChart').getContext('2d');

            // Group data by date and tipe
            const dateGroups = {};
            data.forEach(item => {
                const date = new Date(item.tanggal).toISOString().split('T')[0];
                if (!dateGroups[date]) {
                    dateGroups[date] = { pemasukan: 0, pengeluaran: 0 };
                }
                dateGroups[date][item.tipe] += item.amount;
            });

            // Create array of all dates in range
            const start = new Date(startDate);
            const end = new Date(endDate);
            const allDates = [];
            const currentDate = new Date(start);

            while (currentDate <= end) {
                allDates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Prepare data for chart
            const labels = allDates.map(date => {
                const d = new Date(date);
                return `${d.getDate()}/${d.getMonth() + 1}`;
            });

            const pemasukanData = allDates.map(date => dateGroups[date]?.pemasukan || 0);
            const pengeluaranData = allDates.map(date => dateGroups[date]?.pengeluaran || 0);

            // Destroy existing chart if it exists
            if (dailyLineChart) {
                dailyLineChart.destroy();
            }

            dailyLineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        // === PEMASUKAN → BAR ===
                        {
                            type: 'bar',
                            label: 'Pemasukan',
                            data: pemasukanData,
                            backgroundColor: 'rgba(16, 185, 129, 0.3)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        },

                        // === PENGELUARAN → LINE ===
                        {
                            type: 'line',
                            label: 'Pengeluaran',
                            data: pengeluaranData,
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: 'rgba(239, 68, 68, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { display: false },
                            ticks: { display: false },
                            border: { display: false }
                        },
                        x: {
                            grid: { display: false },
                            border: { display: false }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        },
                        legend: {
                            labels: {
                                boxWidth: 12,
                                padding: 16
                            }
                        }
                    }
                }
            });

            // Update custom legend
            const totalPemasukan = pemasukanData.reduce((a, b) => a + b, 0);
            const totalPengeluaran = pengeluaranData.reduce((a, b) => a + b, 0);
            const totalSaldo = totalPemasukan - totalPengeluaran;

            const legendHtml = `
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(16, 185, 129, 1)"></div>
                    <span>Pemasukan: ${formatCurrency(totalPemasukan)}</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(239, 68, 68, 1)"></div>
                    <span>Pengeluaran: ${formatCurrency(totalPengeluaran)}</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(59, 130, 246, 1)"></div>
                    <span>Saldo: ${formatCurrency(totalSaldo)}</span>
                </div>
            `;
            document.getElementById('dailyLineLegend').innerHTML = legendHtml;
        }

        function updateTipeLegend(legendId, labels, colors, values) {
            const legendContainer = document.getElementById(legendId);
            let legendHtml = '';

            labels.forEach((label, index) => {
                const total = values.reduce((a, b) => a + b, 0);
                const percentage = total > 0 ? Math.round((values[index] / total) * 100) : 0;

                legendHtml += `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: ${colors[index]}"></div>
                        <span>${label}: ${formatCurrency(values[index])} (${percentage}%)</span>
                    </div>
                `;
            });

            legendContainer.innerHTML = legendHtml;
        }

        function updateLegend(legendId, labels, colors, values) {
            const legendContainer = document.getElementById(legendId);
            let legendHtml = '';

            labels.forEach((label, index) => {
                const total = values.reduce((a, b) => a + b, 0);
                const percentage = total > 0 ? Math.round((values[index] / total) * 100) : 0;

                legendHtml += `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: ${colors[index]}"></div>
                        <span>${label}: ${formatCurrency(values[index])} (${percentage}%)</span>
                    </div>
                `;
            });

            legendContainer.innerHTML = legendHtml;
        }

        function generateColors(count) {
            const colors = [
                'rgba(59, 130, 246, 0.8)',    // Blue
                'rgba(16, 185, 129, 0.8)',    // Green
                'rgba(245, 158, 11, 0.8)',    // Yellow
                'rgba(239, 68, 68, 0.8)',     // Red
                'rgba(139, 92, 246, 0.8)',    // Purple
                'rgba(14, 165, 233, 0.8)',    // Sky Blue
                'rgba(249, 115, 22, 0.8)',    // Orange
                'rgba(236, 72, 153, 0.8)',    // Pink
                'rgba(20, 184, 166, 0.8)',    // Teal
                'rgba(120, 113, 108, 0.8)',   // Gray
            ];

            // If we need more colors, generate random ones
            while (colors.length < count) {
                colors.push(`rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.8)`);
            }

            return colors.slice(0, count);
        }

        function renderTable(data) {
            const tableBody = $('#data-table');
            tableBody.empty();

            data.forEach(item => {
                const date = new Date(item.tanggal);
                const formattedDate = date.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                const amountClass = item.tipe === 'pemasukan' ? 'pemasukan-text' : 'pengeluaran-text';
                const sign = item.tipe === 'pemasukan' ? '+' : '-';

                const row = `
                    <tr>
                        <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-gray-800">${formattedDate}</td>
                        <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-gray-800">${item.nama}</td>
                        <td class="px-4 md:px-6 py-4 text-sm text-gray-800">${item.keperluan}</td>
                        <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-gray-800">
                            <span class="category-badge ${getCategoryColor(item.kategori)}">${item.kategori}</span>
                        </td>
                        <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-gray-800">
                            <span class="tipe-badge ${getTipeColor(item.tipe)}">${item.tipe}</span>
                        </td>
                        <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm font-medium ${amountClass}">
                            ${sign} ${formatCurrency(item.amount)}
                        </td>
                        <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm font-medium action-buttons">
                            <button onclick="editTransaksi(${item.ID})" class="text-blue-600 hover:text-blue-900 mr-2 md:mr-3 px-2 py-1 rounded hover:bg-blue-50">
                                <i class="fas fa-edit mr-1"></i>
                                <span class="hidden md:inline">Edit</span>
                            </button>
                            <button onclick="deleteTransaksi(${item.ID})" class="text-red-600 hover:text-red-900 px-2 py-1 rounded hover:bg-red-50">
                                <i class="fas fa-trash-alt mr-1"></i>
                                <span class="hidden md:inline">Hapus</span>
                            </button>
                        </td>
                    </tr>
                `;

                tableBody.append(row);
            });
        }

        function getCategoryColor(category) {
            const colors = {
                'Gaji': 'bg-green-100 text-green-800',
                'Bonus': 'bg-yellow-100 text-yellow-800',
                'Freelance': 'bg-blue-100 text-blue-800',
                'Investasi': 'bg-purple-100 text-purple-800',
                'Recash': 'bg-purple-100 text-purple-800',
                'Hutang': 'bg-red-100 text-red-800',
                'Makan': 'bg-green-100 text-green-800',
                'Kebutuhan Makan': 'bg-green-100 text-green-800',
                'BBM': 'bg-yellow-100 text-yellow-800',
                'Tabungan': 'bg-blue-100 text-blue-800',
                'Obat': 'bg-pink-100 text-pink-800',
                'E-Toll': 'bg-indigo-100 text-indigo-800',
                'Listrik': 'bg-orange-100 text-orange-800',
                'Wifi dan Internet': 'bg-teal-100 text-teal-800',
                'Lain-lain': 'bg-gray-100 text-gray-800'
            };

            return colors[category] || 'bg-gray-100 text-gray-800';
        }

        function getTipeColor(tipe) {
            return tipe === 'pemasukan'
                ? 'bg-green-100 text-green-800'
                : 'bg-red-100 text-red-800';
        }

        function showAddModal() {
            $('#modal-title').text('Tambah Transaksi');
            $('#edit-id').val('');
            $('#form-tipe').val('');
            $('#form-tanggal').val(formatDate(new Date()));
            $('#form-nama').val('');
            $('#form-keperluan').val('');
            $('#form-kategori').val('');
            $('#form-amount').val('');
            $('#modal').removeClass('hidden');
        }

        function editTransaksi(id) {
            $.ajax({
                url: `/transactions/${id}`,
                method: 'GET',
                dataType: 'json',
                success: function (response) {
                    const item = response;
                    $('#modal-title').text('Edit Transaksi');
                    $('#edit-id').val(item.ID);
                    $('#form-tipe').val(item.tipe);
                    $('#form-tanggal').val(formatDate(new Date(item.tanggal)));
                    $('#form-nama').val(item.nama);
                    $('#form-keperluan').val(item.keperluan);
                    $('#form-kategori').val(item.kategori);
                    $('#form-amount').val(item.amount);
                    $('#modal').removeClass('hidden');
                },
                error: function (err) {
                    alert('Gagal mengambil data transaksi');
                    console.error(err);
                }
            });
        }

        function saveTransaksi() {
            const id = $('#edit-id').val();
            const method = id ? 'PUT' : 'POST';
            const url = id ? '/transactions/' + id : '/transactions';

            const data = {
                nama: $('#form-nama').val(),
                keperluan: $('#form-keperluan').val(),
                kategori: $('#form-kategori').val(),
                tipe: $('#form-tipe').val(),
                amount: parseFloat($('#form-amount').val()),
                tanggal: $('#form-tanggal').val()
            };

            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (response) {
                    $('#modal').addClass('hidden');
                    loadData();
                    alert('Data berhasil disimpan!');
                },
                error: function (err) {
                    alert('Gagal menyimpan data!');
                    console.error(err);
                }
            });
        }

        function deleteTransaksi(id) {
            if (confirm('Apakah Anda yakin ingin menghapus data ini?')) {
                $.ajax({
                    url: `/transactions/${id}`,
                    method: 'DELETE',
                    success: function (response) {
                        loadData();
                        alert('Data berhasil dihapus!');
                    },
                    error: function (err) {
                        alert('Gagal menghapus data!');
                        console.error(err);
                    }
                });
            }
        }

        function getRingkasanBulanan() {
            const today = new Date();
            const bulan = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');

            $.ajax({
                url: `/transactions/resume/monthly?bulan=${bulan}`,
                method: 'GET',
                dataType: 'json',
                success: function (response) {
                    alert(`Ringkasan Bulan ${response.periode}:\n\n` +
                        `Pemasukan: ${formatCurrency(response.total_pemasukan)}\n` +
                        `Pengeluaran: ${formatCurrency(response.total_pengeluaran)}\n` +
                        `Saldo: ${formatCurrency(response.saldo)}`);
                },
                error: function (err) {
                    console.error(err);
                }
            });
        }

        function exportToExcel() {
            // Simple export to CSV
            const data = [];
            const rows = $('#data-table tr');

            rows.each(function () {
                const row = [];
                $(this).find('td').each(function () {
                    row.push($(this).text().trim());
                });
                if (row.length > 0) {
                    data.push(row);
                }
            });

            if (data.length > 0) {
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Tanggal,Nama,Keperluan,Kategori,Tipe,Jumlah\n";

                data.forEach(row => {
                    csvContent += row.join(",") + "\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "laporan_keuangan.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
</body>

</html>